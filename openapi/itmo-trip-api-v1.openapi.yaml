openapi: 3.1.0

info:
  title: ITMO.Trip API
  version: 1.0.0

servers:
  - url: http://localhost:8080/itmo-trip

components:
  schemas:
    LoginRequest:
      type: object
      properties:
        username: { type: string }
        password: { type: string, format: password }
      required:
        - username
        - password

    RefreshRequest:
      type: object
      properties:
        refresh_token: { type: string }
      required:
        - refresh_token

    LoginResponse:
      type: object
      properties:
        access_token: { type: string }
        expires_in: { type: integer, format: int64 }
        refresh_token: { type: string }
        refresh_expires_in: { type: integer, format: int64 }
        id_token: { type: string }
        session_state: { type: string }
      required:
        - access_token
        - expires_in
        - refresh_token
        - refresh_expires_in
        - id_token
        - session_state

    LocationTypeResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        code: { type: string }
      required:
        - id
        - code

    TransportTypeResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        logo_url: { type: string }
        name_ru: { type: string }
      required:
        - id
        - name_ru

    TimetableResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        end_time_utc: { type: string, format: time }
        start_time_utc: { type: string, format: time }
      required:
        - id
        - start_time_utc
        - end_time_utc

    UserRequest:
      type: object
      properties:
        bio: { type: string }
        social_network_username: { type: string }

    UserResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        avatar_url: { type: string, }
        bio: { type: string, }
        faculty: { type: string }
        first_name: { type: string }
        last_name: { type: string }
        middle_name: { type: string, }
        social_network_username: { type: string }
        student_id: { type: string }
      required:
        - id
        - faculty
        - first_name
        - last_name
        - student_id

    LocationRequest:
      type: object
      properties:
        latitude: { type: number, format: int64 }
        location_type_id: { type: integer, format: int64 }
        longitude: { type: number, format: int64 }
        name: { type: string }
      required:
        - latitude
        - location_type_id
        - longitude
        - name

    LocationResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        creator:
          $ref: '#/components/schemas/UserResponse'
        latitude: { type: number, format: int64 }
        location_type:
          $ref: '#/components/schemas/LocationTypeResponse'
        longitude: { type: number, format: int64 }
        name: { type: string }
      required:
        - id
        - latitude
        - location_type
        - longitude
        - name

    TripRequest:
      type: object
      properties:
        arrival_location_id: { type: string, format: uuid }
        arrival_time: { type: string, format: date-time, }
        comment: { type: string, }
        departure_location_id: { type: string, format: uuid }
        departure_time: { type: string, format: date-time, }
        series_id: { type: string, format: uuid, }
        status: { type: string }
        transport_type_id: { type: integer, format: int64 }
      required:
        - arrival_location_id
        - departure_location_id
        - transport_type_id

    TripResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        arrival_location:
          $ref: '#/components/schemas/LocationResponse'
        arrival_time: { type: string, format: date-time, }
        comment: { type: string, }
        creator:
          $ref: '#/components/schemas/UserResponse'
        departure_location:
          $ref: '#/components/schemas/LocationResponse'
        departure_time: { type: string, format: date-time, }
        series_id: { type: string, format: uuid, }
        status: { type: string }
        transport_type:
          $ref: '#/components/schemas/TransportTypeResponse'
      required:
        - id
        - arrival_location
        - departure_location
        - status
        - creator
        - transport_type

paths:
  /api/v1/auth/login:
    post:
      tags: [ auth ]
      summary: Sign in
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        401:
          description: Unauthorized. Please check your credentials

  /api/v1/auth/refresh:
    post:
      tags: [ auth ]
      summary: Refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        401:
          description: Unauthorized. Please check your credentials

  /api/v1/me:
    get:
      tags: [ me ]
      summary: Get current user's information
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        401:
          description: Unauthorized

  /api/v1/users/{id}:
    get:
      tags: [ users ]
      summary: Get user by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        404:
          description: User not found
    patch:
      tags: [ users ]
      summary: Update user's bio and social network account
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRequest'
      responses:
        200:
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        403:
          description: 'Forbidden. You can only update your own profile'

  /api/v1/locations:
    get:
      tags: [ locations ]
      summary: Get all locations
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LocationResponse'
    post:
      tags: [ locations ]
      summary: Create a new location
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationRequest'
      responses:
        201:
          description: Location created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'

  /api/v1/locations/my:
    get:
      tags: [ locations ]
      summary: Get current user's locations
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LocationResponse'

  /api/v1/locations/{id}:
    get:
      tags: [ locations ]
      summary: Get location by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        404:
          description: Location not found
    put:
      tags: [ locations ]
      summary: Update location
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationRequest'
      responses:
        200:
          description: Location updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        403:
          description: Location does not belong to current user
        404:
          description: Location not found
    delete:
      tags: [ locations ]
      summary: Delete location
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        204:
          description: Location deleted successfully
        403:
          description: Location does not belong to current user
        404:
          description: Location not found

  /api/v1/trips:
    get:
      tags: [ trips ]
      summary: Get all trips (supports filtering)
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TripResponse'
        400:
          description: Bad request. Please check your filtering parameters
      parameters:
        - name: arrival_time
          in: query
          description: |
            Фильтр по времени прибытия.
            Можно использовать операторы сравнения - gt (greater than), gte (greater than or equal),
            lt (less than), lte (less than or equal), eq (equal).
            Пример: `gt:2023-10-01T00:00:00Z`, `lt:2023-10-31T23:59:59Z`
          required: false
          schema:
            type: string
            example: "gt:2023-10-01T00:00:00Z"
        - name: departure_time
          in: query
          description: |
            Фильтр по времени отправления.
            Поддерживает те же операторы сравнения, что и arrival_time.
          required: false
          schema:
            type: string
            example: "gte:2023-10-01T08:00:00Z"
        - name: arrival_location_id
          in: query
          description: |
            Фильтр по ID места прибытия.
            Можно указать несколько значений через запятую.
          required: false
          schema:
            type: string
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: departure_location_id
          in: query
          description: |
            Фильтр по ID места отправления.
            Можно указать несколько значений через запятую.
          required: false
          schema:
            type: string
            example: "550e8400-e29b-41d4-a716-446655440001"
        - name: transport_type_id
          in: query
          description: |
            Фильтр по ID типа транспорта.
            Можно указать несколько значений через запятую.
          required: false
          schema:
            type: string
            example: "1,2,3"
    post:
      tags: [ trips ]
      summary: Create a new trip
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TripRequest'
      responses:
        201:
          description: Trip created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TripResponse'
        400:
          description: Invalid trip data

  /api/v1/trips/{id}:
    get:
      tags: [ trips ]
      summary: Get trip by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TripResponse'
        404:
          description: Trip not found
    put:
      tags: [ trips ]
      summary: Update trip
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TripRequest'
      responses:
        200:
          description: Trip updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TripResponse'
        403:
          description: Trip does not belong to current user
        404:
          description: Trip not found
    delete:
      tags: [ trips ]
      summary: Delete trip
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        204:
          description: Trip deleted successfully
        403:
          description: Trip does not belong to current user
        404:
          description: Trip not found

  /api/v1/transport-types:
    get:
      tags: [ transport-types ]
      summary: Get all transport types
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TransportTypeResponse'

  /api/v1/location-types:
    get:
      tags: [ location-types ]
      summary: Get all location types
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LocationTypeResponse'

  /api/v1/timetables:
    get:
      tags: [ timetables ]
      summary: Get all timetables
      responses:
        200:
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TimetableResponse'
